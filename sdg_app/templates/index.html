<!doctype html>
<html lang="ja" data-theme="frutiger-aero">

<head>
  <meta charset="utf-8">
  <title>MABEL Studio — Visual Agent Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
  <header class="topbar glass">
    <div class="brand">
      <span class="logo-orb" aria-hidden="true"></span>
      <strong class="brand-title">MABEL Studio</strong>
      <span class="sub">Visual YAML Builder for AI Agents</span>
    </div>
    <div class="top-actions">
      <button id="btnClear" class="ghost">New</button>
      <button id="btnAutoLayout" class="accent" title="exec順で自動整列">Auto Layout</button>
      <button id="btnV2Settings" class="accent" title="v2設定（runtime, budgets, globals等）"><span
          class="icon icon-settings"><svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg></span>v2設定</button>
      <details class="ghost-d">
        <summary>Help</summary>
        <div class="popover">
          <p><b>クイックヘルプ</b></p>
          <ul>
            <li>右の <b>AI / LOGIC / CODE / END</b> を左のキャンバスへドラッグ</li>
            <li>ノードをクリックして編集（任意項目は <code><details></code> 内）</li>
            <li><b>Save</b> で自動配線・自動整列</li>
            <li>移動: <span class="kbd">Space</span>+ドラッグ ／ ズーム: <span class="kbd">Ctrl/⌘</span>+ホイール</li>
            <li>YAML: <b>Generate</b> で保存 ／ <b>Import</b> で読込</li>
          </ul>
        </div>
      </details>
    </div>
  </header>

  <main class="split">
    <!-- 左：ノードキャンバス -->
    <section id="canvas" class="canvas" tabindex="0" aria-label="Node canvas">
      <svg id="wires" class="wires" preserveAspectRatio="none" aria-hidden="true">
        <defs id="wire-defs">
          <!-- ライトブルー→ライムの配線グラデーション + 微グロー -->
          <linearGradient id="edgeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="var(--line-start)"></stop>
            <stop offset="100%" stop-color="var(--line-end)"></stop>
          </linearGradient>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2.5" result="blur"></feGaussianBlur>
            <feMerge>
              <feMergeNode in="blur"></feMergeNode>
              <feMergeNode in="SourceGraphic"></feMergeNode>
            </feMerge>
          </filter>
          <!-- ★ 矢印のサイズを線幅基準に（ズームでも自然） -->
          <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6"
            orient="auto-start-reverse" markerUnits="strokeWidth">
            <path d="M 0 0 L 10 5 L 0 10 z" style="fill: var(--line-end);"></path>
          </marker>
        </defs>
      </svg>
      <div id="nodes" class="nodes"></div>
      <div class="canvas-hint" role="status" aria-live="polite">
        Drag or press <span class="kbd">Enter</span> to add • <span class="kbd">Space</span>+drag to pan • <span
          class="kbd">Ctrl/⌘</span>+wheel to zoom
      </div>
      <!-- ★ Zoom HUD はJSで挿入（.zoom-hud） -->
    </section>

    <!-- 右：サイドバー -->
    <aside class="sidebar glass" role="complementary" aria-label="設定サイドバー">
      <!-- モデル設定（右上） -->
      <section class="panel glass" id="modelsPanel" role="region" aria-labelledby="hdr-models">
        <div class="panel-head clickable">
          <h2 id="hdr-models">AIモデル設定</h2>
          <button id="btnAddModel" class="accent" type="button">+ Add Model</button>
        </div>
        <div class="panel-tools">
          <button id="btnModelsSaveLocal" class="ghost" type="button" title="ブラウザに保存（ブロックへは影響しません）">Save</button>
          <button id="btnModelsLoadLocal" class="ghost" type="button" title="ブラウザから読込（ブロックへは影響しません）">Load</button>
          <button id="btnModelsReset" class="ghost danger" type="button" title="既定のモデル設定に戻す（ブロックは維持）">Reset</button>
          <button id="btnModelsDownloadYAML" class="primary wide" type="button" title="モデル設定のみをYAML保存">Models
            YAML</button>
        </div>
        <div class="panel-note small-note">モデル設定のみの操作です（ブロックには影響しません）。</div>
        <div id="modelsList" class="models-list">
          <!-- JSで挿入 -->
        </div>
      </section>

      <!-- ブロック配置（右下） -->
      <section class="panel glass" id="libraryPanel" role="region" aria-labelledby="hdr-library">
        <div class="panel-head">
          <h2 id="hdr-library">ブロック配置</h2>
        </div>
        <div class="library" id="library">
          <div class="lib-item" draggable="true" data-type="start" title="STARTブロック（UserInput出力のみ）" tabindex="0">
            <div class="lib-icon"><span class="icon icon-start"><svg viewBox="0 0 24 24">
                  <polygon points="5 3 19 12 5 21 5 3" />
                </svg></span></div>
            <div class="lib-name">START</div>
          </div>
          <div class="lib-item" draggable="true" data-type="ai" title="AIブロック" tabindex="0">
            <div class="lib-icon"><span class="icon icon-ai"><svg viewBox="0 0 24 24">
                  <rect x="4" y="4" width="16" height="16" rx="2" ry="2" />
                  <rect x="9" y="9" width="6" height="6" />
                  <line x1="9" y1="1" x2="9" y2="4" />
                  <line x1="15" y1="1" x2="15" y2="4" />
                  <line x1="9" y1="20" x2="9" y2="23" />
                  <line x1="15" y1="20" x2="15" y2="23" />
                  <line x1="20" y1="9" x2="23" y2="9" />
                  <line x1="20" y1="14" x2="23" y2="14" />
                  <line x1="1" y1="9" x2="4" y2="9" />
                  <line x1="1" y1="14" x2="4" y2="14" />
                </svg></span></div>
            <div class="lib-name">AI</div>
          </div>
          <div class="lib-item" draggable="true" data-type="logic" title="LOGICブロック" tabindex="0">
            <div class="lib-icon"><span class="icon icon-logic"><svg viewBox="0 0 24 24">
                  <polyline points="16 3 21 3 21 8" />
                  <line x1="4" y1="20" x2="21" y2="3" />
                  <polyline points="21 16 21 21 16 21" />
                  <line x1="15" y1="15" x2="21" y2="21" />
                  <line x1="4" y1="4" x2="9" y2="9" />
                </svg></span></div>
            <div class="lib-name">LOGIC</div>
          </div>
          <div class="lib-item" draggable="true" data-type="python" title="CODEブロック（type: python）" tabindex="0">
            <div class="lib-icon"><span class="icon icon-code"><svg viewBox="0 0 24 24">
                  <polyline points="16 18 22 12 16 6" />
                  <polyline points="8 6 2 12 8 18" />
                </svg></span></div>
            <div class="lib-name">CODE</div>
          </div>
          <div class="lib-item" draggable="true" data-type="end" title="ENDブロック（type: end）" tabindex="0">
            <div class="lib-icon"><span class="icon icon-end"><svg viewBox="0 0 24 24">
                  <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                  <line x1="4" y1="22" x2="4" y2="15" />
                </svg></span></div>
            <div class="lib-name">END</div>
          </div>
        </div>

        <div class="export">
          <div class="export-controls">
            <button id="btnGenerate" class="primary" type="button">YAML Generate</button>
            <button id="btnPreview" class="ghost" type="button">YAML Preview</button>
            <button id="btnImport" class="ghost" type="button">YAML Import</button>
            <input type="file" id="yamlFile" accept=".yaml,.yml,text/yaml" hidden>
          </div>
          <div id="importDrop" class="import-drop" aria-label="YAML dropzone">
            Drop .yaml/.yml here to import
          </div>
        </div>
      </section>
    </aside>
  </main>

  <!-- ブロック編集モーダル -->
  <dialog id="editorModal" class="modal glass">
    <form method="dialog" id="editorForm">
      <header class="modal-head">
        <h3 id="editorTitle">Block Editor</h3>
        <!-- 変更: ブロックの×と同意匠にするため del を付与 -->
        <button class="del icon-close" value="cancel" aria-label="close" type="button"
          onclick="this.closest('dialog').close()"><span class="icon icon-x"><svg viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg></span></button>
      </header>
      <div class="modal-body" id="editorBody">
        <!-- JSでブロック別フォームを生成 -->
      </div>
      <footer class="modal-foot">
        <button class="ghost" value="cancel" type="button" onclick="this.closest('dialog').close()">Cancel</button>
        <button id="btnSaveBlock" class="accent" value="default">Save</button>
      </footer>
    </form>
  </dialog>

  <!-- YAMLプレビュー用モーダル -->
  <dialog id="yamlModal" class="modal glass">
    <form method="dialog" id="yamlForm">
      <header class="modal-head">
        <h3>YAML Preview</h3>
        <button class="del icon-close" value="cancel" aria-label="close" type="button"
          onclick="this.closest('dialog').close()"><span class="icon icon-x"><svg viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg></span></button>
      </header>
      <div class="modal-body">
        <textarea id="yamlPreview" spellcheck="false" aria-label="YAML preview"
          style="width:100%; height:60vh;"></textarea>
      </div>
      <footer class="modal-foot">
        <button class="ghost" value="cancel" type="button" onclick="this.closest('dialog').close()">Close</button>
        <button id="btnYamlApply" class="accent" type="button">Apply</button>
      </footer>
    </form>
  </dialog>

  <!-- モデル設定モーダル -->
  <dialog id="modelModal" class="modal glass">
    <form method="dialog" id="modelForm">
      <header class="modal-head">
        <h3 id="modelModalTitle">Model Settings</h3>
        <button class="del icon-close" value="cancel" aria-label="close" type="button"
          onclick="this.closest('dialog').close()"><span class="icon icon-x"><svg viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg></span></button>
      </header>
      <div class="modal-body" id="modelModalBody">
        <!-- JSでモデル設定フォームを生成 -->
      </div>
      <footer class="modal-foot">
        <button class="ghost" value="cancel" type="button" onclick="this.closest('dialog').close()">Cancel</button>
        <button id="btnSaveModel" class="accent" value="default" type="button"
          onclick="this.closest('dialog').close()">Save</button>
      </footer>
    </form>
  </dialog>

  <!-- v2設定モーダル -->
  <dialog id="v2SettingsModal" class="modal glass" style="width: 90%; max-width: 1000px;">
    <form method="dialog" id="v2SettingsForm">
      <header class="modal-head">
        <h3>MABEL v2 設定</h3>
        <button class="del icon-close" value="cancel" aria-label="close" type="button"
          onclick="this.closest('dialog').close()"><span class="icon icon-x"><svg viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg></span></button>
      </header>
      <div class="modal-body" id="v2SettingsBody" style="max-height: 70vh; overflow-y: auto;">
        <!-- JSで設定フォームを生成 -->
      </div>
      <footer class="modal-foot">
        <button class="ghost" value="cancel" type="button" onclick="this.closest('dialog').close()">Cancel</button>
        <button id="btnSaveV2Settings" class="accent" value="default">Save</button>
      </footer>
    </form>
  </dialog>

  <script src="{{ url_for('static', filename='js/app.core.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.graph.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.yaml.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.ui.models.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.ui.nodes.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.ui.editor.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.ui.v2settings.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.ui.init.js') }}"></script>
</body>

</html>